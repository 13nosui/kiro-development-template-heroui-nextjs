name: ðŸ” Secure Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production
      skip_tests:
        description: 'Skip security tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  FORCE_COLOR: 3

jobs:
  # ==============================================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£äº‹å‰ãƒã‚§ãƒƒã‚¯
  # ==============================================
  security-check:
    name: ðŸ” Security Pre-check
    runs-on: ubuntu-latest
    
    outputs:
      security-passed: ${{ steps.security-result.outputs.passed }}
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ãƒ•ãƒ«å±¥æ­´å–å¾—ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ç”¨ï¼‰
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ”’ Verify environment variables
        env:
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          CSRF_SECRET: ${{ secrets.CSRF_SECRET }}
        run: |
          echo "ðŸ”‘ Environment variables verification..."
          npm run env:validate
          
          if [ $? -eq 0 ]; then
            echo "âœ… Environment variables are valid"
          else
            echo "âŒ Environment variables validation failed"
            exit 1
          fi
      
      - name: ðŸ›¡ï¸ Security audit
        run: |
          echo "ðŸ” Running security audit..."
          npm audit --audit-level=high
          
          echo "ðŸ”Ž Checking for hardcoded secrets..."
          npm run security:secrets
          
          echo "ðŸ§ Running comprehensive security check..."
          npm run security:check
      
      - name: ðŸ“Š Code quality analysis
        if: ${{ !inputs.skip_tests }}
        run: |
          echo "ðŸ” TypeScript type checking..."
          npm run type-check
          
          echo "ðŸ” ESLint analysis..."
          npm run lint:check
      
      - name: ðŸ—ï¸ Build test
        env:
          # æœ€å°é™ã®Secretsï¼ˆãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆç”¨ï¼‰
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          CSRF_SECRET: ${{ secrets.CSRF_SECRET }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
        run: |
          echo "ðŸ—ï¸ Testing production build..."
          npm run build
          
          if [ $? -eq 0 ]; then
            echo "âœ… Build test passed"
          else
            echo "âŒ Build test failed"
            exit 1
          fi
      
      - name: ðŸŽ¯ Set security result
        id: security-result
        run: |
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "âœ… All security checks passed"

  # ==============================================
  # æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  # ==============================================
  deploy-production:
    name: ðŸš€ Deploy to Production
    needs: security-check
    if: needs.security-check.outputs.security-passed == 'true'
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ—ï¸ Build application
        env:
          # ðŸ”¥ Firebaseè¨­å®š
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          
          # ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          CSRF_SECRET: ${{ secrets.CSRF_SECRET }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          RATE_LIMIT_SECRET: ${{ secrets.RATE_LIMIT_SECRET }}
          
          # ðŸŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
          NEXT_PUBLIC_WS_URL: ${{ secrets.NEXT_PUBLIC_WS_URL }}
          
          # ðŸŽ¨ å¤–éƒ¨APIï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
          FIGMA_WEBHOOK_SECRET: ${{ secrets.FIGMA_WEBHOOK_SECRET }}
          FIGMA_PERSONAL_ACCESS_TOKEN: ${{ secrets.FIGMA_PERSONAL_ACCESS_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          
          # ðŸ“§ é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          
          # ðŸ“Š ç›£è¦–ãƒ»åˆ†æž
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          NEXT_PUBLIC_GA_ID: ${{ secrets.NEXT_PUBLIC_GA_ID }}
          NEXT_PUBLIC_HOTJAR_ID: ${{ secrets.NEXT_PUBLIC_HOTJAR_ID }}
          NEXT_PUBLIC_LOGROCKET_ID: ${{ secrets.NEXT_PUBLIC_LOGROCKET_ID }}
          
          # â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          
          # ðŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          echo "ðŸ—ï¸ Building production application..."
          npm run build
          
          echo "ðŸ“Š Build statistics:"
          du -sh .next/ || echo "Build directory not found"
          
          echo "âœ… Build completed successfully"
      
      - name: ðŸ” Deploy to Vercel
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          echo "ðŸš€ Starting deployment to Vercel..."
          
          # Vercel CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install -g vercel@latest
          
          # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã®å®Ÿè¡Œ
          DEPLOY_URL=$(vercel deploy --prod --token $VERCEL_TOKEN --confirm)
          
          echo "ðŸŒ Deployed to: $DEPLOY_URL"
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç°¡æ˜“ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          echo "ðŸ¥ Health check..."
          sleep 10
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Health check passed (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸ Health check warning (HTTP $HTTP_STATUS)"
          fi
      
      - name: ðŸ“Š Post-deployment verification
        env:
          DEPLOY_URL: ${{ steps.deploy.outputs.url }}
        run: |
          echo "ðŸ” Post-deployment verification..."
          
          # SSLè¨¼æ˜Žæ›¸ã®ç¢ºèª
          echo "ðŸ”’ SSL certificate check..."
          echo | openssl s_client -servername $(echo $DEPLOY_URL | sed 's|https://||') -connect $(echo $DEPLOY_URL | sed 's|https://||'):443 2>/dev/null | openssl x509 -noout -dates
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç¢ºèª
          echo "ðŸ›¡ï¸ Security headers check..."
          curl -I "$DEPLOY_URL" | grep -E "(X-Frame-Options|X-Content-Type-Options|Strict-Transport-Security|Content-Security-Policy)"
          
          echo "âœ… Post-deployment verification completed"

  # ==============================================
  # é€šçŸ¥ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤çµæžœï¼‰
  # ==============================================
  notify:
    name: ðŸ“¢ Notify Results
    needs: [security-check, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¤ Slack notification (Success)
        if: needs.deploy-production.result == 'success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ðŸš€ Production deployment successful!",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ðŸš€ Production Deployment Successful*\n\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n*Actor:* ${{ github.actor }}\n*Workflow:* ${{ github.workflow }}"
                    }
                  }
                ]
              }' \
              "$SLACK_WEBHOOK_URL"
          fi
      
      - name: ðŸ“¤ Slack notification (Failure)
        if: needs.deploy-production.result == 'failure' || needs.security-check.result == 'failure'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "âŒ Production deployment failed!",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*âŒ Production Deployment Failed*\n\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n*Actor:* ${{ github.actor }}\n*Workflow:* ${{ github.workflow }}\n\n*Check the logs:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  }
                ]
              }' \
              "$SLACK_WEBHOOK_URL"
          fi
      
      - name: ðŸ“§ Discord notification (Success)
        if: needs.deploy-production.result == 'success'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "embeds": [
                  {
                    "title": "ðŸš€ Production Deployment Successful",
                    "color": 65280,
                    "fields": [
                      {"name": "Repository", "value": "${{ github.repository }}", "inline": true},
                      {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                      {"name": "Actor", "value": "${{ github.actor }}", "inline": true}
                    ],
                    "timestamp": "${{ github.event.head_commit.timestamp }}"
                  }
                ]
              }' \
              "$DISCORD_WEBHOOK_URL"
          fi

  # ==============================================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°
  # ==============================================
  security-audit-log:
    name: ðŸ“‹ Security Audit Log
    needs: [security-check, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“ Generate security audit log
        run: |
          echo "ðŸ“‹ Generating security audit log..."
          
          cat > security-audit-log.md << EOF
          # ðŸ”’ Security Audit Log
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow:** ${{ github.workflow }}
          **Run ID:** ${{ github.run_id }}
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Actor:** ${{ github.actor }}
          
          ## Security Check Results
          
          - **Security Pre-check:** ${{ needs.security-check.result }}
          - **Deployment:** ${{ needs.deploy-production.result }}
          
          ## Environment Variables Verified
          
          - âœ… ENCRYPTION_KEY
          - âœ… JWT_SECRET  
          - âœ… CSRF_SECRET
          - âœ… SESSION_SECRET
          - âœ… Firebase Configuration
          
          ## Security Measures Applied
          
          - [x] Environment variable validation
          - [x] Dependency vulnerability scan
          - [x] Hardcoded secrets scan
          - [x] TypeScript type checking
          - [x] ESLint security rules
          - [x] Production build test
          - [x] SSL certificate verification
          - [x] Security headers verification
          
          ## Deployment Information
          
          - **Environment:** ${{ github.event.inputs.environment || 'production' }}
          - **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Status:** ${{ needs.deploy-production.result }}
          
          ---
          
          *This log is automatically generated by GitHub Actions.*
          EOF
          
          echo "ðŸ“„ Security audit log generated"
          cat security-audit-log.md
      
      - name: ðŸ“¤ Upload audit log
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-log-${{ github.run_id }}
          path: security-audit-log.md
          retention-days: 90
